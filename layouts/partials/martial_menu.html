{{- /* 邏輯控制：僅在一般文章頁顯示 */ -}}
{{- if and (eq .Kind "page") (ne .Type "about") (ne .Layout "about") (ne .Title "關於我") -}}

<div id="martial-toc" class="martial-sidebar">
    <div class="sidebar-header">
        <input type="text" id="martialSearch" placeholder="" onkeyup="doMartialSearch()">
    </div>
    <nav class="martial-nav">
        {{- /* 修正標題重複：直接抓取一級 Section */ -}}
        {{- range .Site.Sections -}}
            {{- template "render-section-fixed" . -}}
        {{- end -}}
    </nav>
</div>

<style>
/* 1. 主框架：寬度加寬，位置設為 45px */
body #martial-toc.martial-sidebar { 
    position: fixed !important; 
    right: 15px !important; 
    top: 45px !important; /* 回歸 45px 精準對齊 */
    width: 252px !important; 
    max-height: 85vh !important; 
    z-index: 999999 !important; 
    background: rgba(35, 35, 35, 0.95) !important; 
    border: 1px solid rgba(0, 150, 255, 0.5) !important; /* 邊框改為偏藍系 */
    padding: 12px !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 25px rgba(0,0,0,0.6) !important;
}

/* 2. 顏色強制修正：亮電光藍 (#0096FF) */
/* 使用 body #martial-toc 確保權限高於主題所有 CSS */

body #martial-toc .m-label,
body #martial-toc .m-label span,
body #martial-toc .m-arrow { 
    color: #0096FF !important; /* 亮電光藍：偏藍系的亮色 */
    font-weight: 800 !important;
    font-size: 1.1em !important;
    opacity: 1 !important;
}

/* 文章標題：純白色 */
body #martial-toc .m-tier-3 li a {
    color: #ffffff !important; 
    text-decoration: none !important;
    display: block !important;
    padding: 6px 0 !important;
    opacity: 1 !important;
}

/* 懸停與選中：亮紅色 */
body #martial-toc a:hover, 
body #martial-toc a.is-active { 
    color: #ff3333 !important; 
    font-weight: 900 !important; 
}

/* 3. 搜尋框修正 */
#martialSearch { 
    width: 100% !important;
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1.5px solid #0096FF !important;
    color: #ffffff !important;
    padding: 8px !important;
    margin-bottom: 12px !important;
    border-radius: 4px !important;
    outline: none !important;
}

/* 結構微調 */
.martial-nav { overflow-y: auto !important; max-height: calc(85vh - 70px) !important; }
.m-label { cursor: pointer; padding: 8px 0; border-bottom: 1px solid rgba(0, 150, 255, 0.2); display: flex; justify-content: space-between; align-items: center; }
.m-content { display: none; padding-left: 12px; border-left: 1px solid rgba(0, 150, 255, 0.3); }
.active > .m-content { display: block !important; }
.m-tier-3 { list-style: none !important; padding: 0 !important; margin: 5px 0 !important; }
</style>

<script>
function mToggle(el) { event.stopPropagation(); el.parentElement.classList.toggle('active'); }
function doMartialSearch() {
    let k = document.getElementById('martialSearch').value.toLowerCase();
    let items = document.querySelectorAll('.m-tier-3 li');
    if (k.length > 0) { document.querySelectorAll('.m-tier, .m-content').forEach(n => n.classList.add('active')); }
    items.forEach(li => {
        let text = li.textContent.toLowerCase();
        li.style.display = text.includes(k) ? "block" : "none";
    });
}
</script>

{{- end -}}

{{- define "render-section-fixed" -}}
    <div class="m-tier">
        <div class="m-label" onclick="mToggle(this)">
            {{ .Title }} <span class="m-arrow">▼</span>
        </div>
        <div class="m-content">
            {{- range .Sections -}}
                {{- template "render-section-fixed" . -}}
            {{- end -}}
            <ul class="m-tier-3">
                {{- range .RegularPages -}}
                <li><a href="{{ .RelPermalink }}" class="{{ if eq $.RelPermalink .RelPermalink }}is-active{{ end }}">{{ .Title }}</a></li>
                {{- end -}}
            </ul>
        </div>
    </div>
{{- end -}}